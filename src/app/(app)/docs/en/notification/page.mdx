
# Notifications Guide

Dormitricity's notification system is a powerful tool to help you stay on top of your electricity balance. This guide covers everything from setup and testing to understanding the alert logic.

## Configuration Steps

To configure notifications for a dormitory subscription, follow these steps:

1.  **Open Settings**: On the dashboard, find the subscription card for the dormitory you want to configure. Click the **Settings** button (gear icon) to open the notification settings dialog.

2.  **Choose a Channel**: Select your desired notification channel from the dropdown menu.
    *   **None**: Disables all notifications for this subscription.
    *   **WeCom (企业微信)**: Sends alerts via a WeCom group bot.
    *   **Feishu (飞书)**: Sends alerts via a Feishu group bot.
    *   **ServerChan (Server酱)**: Sends alerts to your personal accounts via the ServerChan service.

3.  **Provide Token/Webhook URL**: This input is smart and flexible.
    *   **Paste a Full URL**: If you have a full webhook URL from Feishu or WeCom, just paste it in. The system will automatically extract the necessary token and select the correct channel for you.
    *   **Paste a Token/Key**: If you have a token (like a ServerChan SendKey or a raw Feishu/WeCom token), paste it in and manually select the corresponding channel.
    *   The system validates the token/URL format in real-time. An invalid input will be flagged.

4.  **Set Notification Rules**: You can enable one or both of the following rules.
    *   **Low Power Threshold**: Enable the switch and set a specific `kWh` value. You will receive an alert when your dormitory's balance drops **below** this value.
    *   **Depletion Threshold**: Enable the switch and set a number of hours. You will receive an alert when the system predicts your electricity will run out in **less than** this amount of time. The prediction is based on your recent power consumption rate.

5.  **Configure Cooldown**: Choose a cooldown period (e.g., 12, 24, or 48 hours). This prevents you from receiving the same alert too frequently. After an alert is sent, no new alerts for the same rule will be sent until the cooldown period has passed.

6.  **Test Your Settings**: Before saving, it's highly recommended to test your configuration.
    *   Click the **"Test"** button.
    *   A test message, including the dormitory's `canonical_id`, will be sent to your selected channel.
    *   A checkmark will appear on the button if the test is successful.
    *   If it fails, an error message will appear below the token input field (e.g., "Test Failed: Invalid Token").

7.  **Save**: Once you are satisfied with your settings, click **"Save"**. The settings dialog will close automatically upon a successful save.

## How Alerts Are Triggered

The backend system checks for potential alerts every time new electricity data is received from the crawler (approximately every 10 minutes).

Here’s the logic:

1.  **Data Ingestion**: The system receives a new electricity balance reading for a specific dormitory.
2.  **Rule Check**: It then checks all subscriptions for that dormitory that have notifications enabled.
3.  **Condition Evaluation**:
    *   For the **Low Power Threshold**, it checks if `current_balance < threshold_kwh`.
    *   For the **Depletion Threshold**, it calculates the `estimated_hours_remaining` and checks if `estimated_hours_remaining < within_hours`.
4.  **Cooldown Check**: Before sending an alert, the system checks the `last_notified_ts` for that specific rule. If the time since the last alert is less than the configured `cooldown_sec`, the alert is suppressed.
5.  **Dispatch**: If all conditions are met and the cooldown has passed, a notification is sent to your configured channel. The message will be informative, including the dormitory ID, the reason for the alert (e.g., "Low Power Warning"), and the current balance.

## Unsubscribing and Deleting

*   **Unsubscribe**: Inside the settings dialog, you will find an **"Unsubscribe"** button. This will remove the subscription from your dashboard entirely. This action requires confirmation.
*   **Account Deletion**: To delete your entire account and all associated data, go to the **Account** page from the sidebar.
