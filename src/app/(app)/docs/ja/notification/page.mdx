
# 通知ガイド

Dormitricity の通知システムは、電力残量を常に把握するための強力なツールです。このガイドでは、設定やテストからアラートのロジックの理解まで、すべてをカバーしています。

## 設定手順

寮のサブスクリプションに通知を設定するには、次の手順に従ってください。

1.  **設定を開く**：ダッシュボードで、設定したい寮のサブスクリプションカードを見つけます。**設定** ボタン（歯車アイコン）をクリックして、通知設定ダイアログを開きます。

2.  **チャンネルを選択**：ドロップダウンメニューから希望の通知チャンネルを選択します。
    *   **None (なし)**：このサブスクリプションのすべての通知を無効にします。
    *   **WeCom (企業微信)**：WeCom グループボット経由でアラートを送信します。
    *   **Feishu (飛書)**：Feishu グループボット経由でアラートを送信します。
    *   **ServerChan (Server酱)**：ServerChan サービス経由で個人のアカウントにアラートを送信します。

3.  **トークン/Webhook URL を提供**：この入力フィールドはスマートで柔軟です。
    *   **完全な URL を貼り付け**：Feishu や WeCom からの完全な webhook URL をお持ちの場合は、そのまま貼り付けてください。システムが自動的に必要なトークンを抽出し、正しいチャンネルを選択します。
    *   **トークン/キーを貼り付け**：トークン（ServerChan の SendKey や、生の Feishu/WeCom トークンなど）をお持ちの場合は、それを貼り付けてから、対応するチャンネルを手動で選択してください。
    *   システムはトークン/URL の形式をリアルタイムで検証します。無効な入力はフラグが立てられます。

4.  **通知ルールを設定**：以下のルールのいずれか、または両方を有効にできます。
    *   **低電力しきい値**：スイッチを有効にし、特定の `kWh` 値を設定します。寮の残量がこの値を **下回った** ときにアラートが送信されます。
    *   **枯渇しきい値**：スイッチを有効にし、時間数を設定します。システムが電力がこの時間数 **未満** でなくなると予測したときにアラートが送信されます。この予測は、最近の電力消費率に基づいています。

5.  **クールダウンを設定**：クールダウン期間（例：12、24、48 時間）を選択します。これにより、同じアラートを頻繁に受信するのを防ぎます。アラートが送信された後、クールダウン期間が経過するまで、同じルールに対する新しいアラートは送信されません。

6.  **設定をテスト**：保存する前に、設定をテストすることを強くお勧めします。
    *   **「テスト」** ボタンをクリックします。
    *   寮の `canonical_id` を含むテストメッセージが、選択したチャンネルに送信されます。
    *   テストが成功すると、ボタンにチェックマークが表示されます。
    *   失敗した場合は、トークン入力フィールドの下にエラーメッセージが表示されます（例：「テスト失敗：無効なトークン」）。

7.  **保存**：設定に満足したら、**「保存」** をクリックします。正常に保存されると、設定ダイアログは自動的に閉じます。

## アラートのトリガー方法

バックエンドシステムは、クローラーから新しい電力データを受信するたび（約 10 分ごと）に、潜在的なアラートをチェックします。

ロジックは次のとおりです。

1.  **データ受信**：システムは特定の寮の新しい電力残量測定値を受信します。
2.  **ルールチェック**：次に、その寮に対して通知が有効になっているすべてのサブスクリプションをチェックします。
3.  **条件評価**：
    *   **低電力しきい値** の場合、`現在の残量 < しきい値 (threshold_kwh)` をチェックします。
    *   **枯渇しきい値** の場合、`推定残り時間` を計算し、`推定残り時間 < しきい値 (within_hours)` をチェックします。
4.  **クールダウンチェック**：アラートを送信する前に、システムはその特定のルールの `last_notified_ts`（最終通知タイムスタンプ）をチェックします。最後のアラートからの時間が設定された `cooldown_sec`（クールダウン秒数）より短い場合、アラートは抑制されます。
5.  **ディスパッチ**：すべての条件が満たされ、クールダウン期間が経過した場合、通知が設定されたチャンネルに送信されます。メッセージには、寮の ID、アラートの理由（例：「低電力警告」）、および現在の残量が含まれます。

## サブスクリプションの解除と削除

*   **サブスクリプションの解除**：設定ダイアログ内に **「サブスクリプションの解除」** ボタンがあります。これにより、サブスクリプションがダッシュボードから完全に削除されます。この操作には確認が必要です。
*   **アカウントの削除**：アカウント全体と関連するすべてのデータを削除するには、サイドバーから **アカウント** ページに移動します。
