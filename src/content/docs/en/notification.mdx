import { AlertTriangle, Hourglass, Settings } from "lucide-react";
import { InlineChannelIcon } from "@/components/subs/ChannelIcon";
import * as React from "react";
import { NoticePreview, CodeBlock, RuleTitle } from "@/components/md/NoticePreview"

# Notification Configuration

## Connecting Notification Apps

### WeCom (Enterprise WeChat)

1.  Create a WeCom group chat.
2.  Follow the [official tutorial](https://open.work.weixin.qq.com/help2/pc/14931) to create a bot and get its Webhook URL.
3.  Paste the URL into the settings dialog.
4.  (Recommended) Click the test button to verify that the configuration is valid.

### Feishu

Similar to WeCom, you can create a bot in a Feishu group to get a Webhook URL. Paste the URL or just the token part into the settings.

### ServerChan

[ServerChan](https://sct.ftqq.com/) is a unified push notification API service that adapts to multiple platforms and software. You can obtain a SendKey and use it as your token.

It can push messages through the following channels:

-   WeCom App Messages: Receive messages directly in WeChat without installing the WeCom client, with full content displayed.
-   Mobile Client: An official beta version is available for Android, and the Bark channel can be used for iOS.
-   Group Bots: WeCom, DingTalk, and Feishu groups.
-   WeChat Official/Test Accounts: Relies on the template message interface (WeChat may deprecate this interface someday, so it's advisable to configure multiple channels for easy switching).
-   Email and SMS are not natively supported but can be implemented by calling other cloud services through custom channels.

> Compared to WeCom/Feishu, ServerChan can push notifications to your personal WeChat via an official account without needing to create a group.

## Configuring Notifications

1.  **Open Settings**: On the dashboard, find the subscription card for the dorm you want to configure. Click the **Settings** <Settings className="h-4 w-4 inline-block align-middle ml-1" /> button to open the notification settings dialog.

2.  **Select a Channel**: Choose a notification channel from the dropdown menu.
    -   <InlineChannelIcon channel="none" /> **None**: Disables all notifications for this subscription.
    -   <InlineChannelIcon channel="wxwork" /> **WeCom**: Sends alerts via a WeCom group bot.
    -   <InlineChannelIcon channel="feishu" /> **Feishu**: Sends alerts via a Feishu group bot.
    -   <InlineChannelIcon channel="serverchan" /> **ServerChan**: Sends alerts to your personal account or other compatible notification channels.

3.  **Provide Token / Webhook URL**
    -   **Paste Full URL**: Automatically extracts the token and identifies the channel.
    -   **Paste Token Only**: Please select the corresponding channel manually.
    -   The input is validated in real-time, and incorrect formats will be rejected.

4.  **Set Notification Rules**
    -   **Low Power Threshold**: Triggers when the dorm's remaining electricity falls **below** the set `kWh` threshold.

<CodeBlock title="txt">{"Dormitricity: Low Power Alert\nDorm ${canonical_id} has ${last_kwh} kWh remaining, which is below your threshold of ${threshold_kwh} kWh."}</CodeBlock>

    -   **Depletion Time Threshold**: Triggers when the power is predicted to run out in **less than** the specified number of hours (calculated based on recent power consumption).

<CodeBlock title="txt">
  {"Dormitricity: Imminent Depletion Alert\nDorm ${canonical_id} has ${last_kwh} kWh remaining and is expected to run out in ${hours_remaining} hours, which is below your ${within_hours}-hour threshold."}
</CodeBlock>

5.  **Cooldown Period**: Choose a cooldown period like 12 / 24 / 48 hours to avoid duplicate messages. The same rule will not trigger again during the cooldown period.

6.  **Test**: Click **Test**, and the system will send a test message containing the dormitory ID.

<CodeBlock title="txt">
  {"Dormitricity Notification Test\n"}
  {"You are setting up notifications for dorm ${canonical_id}. This is a test message to verify that your notification configuration is working correctly."}
</CodeBlock>

    If successful, a checkmark will appear on the button; otherwise, an error will be displayed, for example:

<CodeBlock title="txt">
  Test Failed: Notify API error(19001): param invalid: incoming webhook access token invalid
</CodeBlock>

7.  **Save**: After confirming your settings, click **Save**.

8.  **Unsubscribe**: In the settings dialog, click **Unsubscribe** (this action requires confirmation).