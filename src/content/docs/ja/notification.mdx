import { AlertTriangle, Hourglass, Settings } from "lucide-react";
import { InlineChannelIcon } from "@/components/subs/ChannelIcon";
import * as React from "react";
import { NoticePreview, CodeBlock, RuleTitle } from "@/components/md/NoticePreview"

# 通知設定

## 通知アプリの接続

### WeCom (企業WeChat)

1.  WeComグループチャットを作成します。
2.  [公式チュートリアル](https://open.work.weixin.qq.com/help2/pc/14931)に従ってボットを作成し、Webhook URLを取得します。
3.  設定ダイアログにURLを貼り付けます。
4.  （推奨）テストボタンをクリックして、設定が有効か確認します。

### Feishu

WeComと同様に、Feishuグループでボットを作成してWebhook URLを取得できます。URL全体またはトークン部分のみを設定に貼り付けます。

### ServerChan

[ServerChan](https://sct.ftqq.com/)は、複数のプラットフォームやソフトウェアに対応した統一プッシュ通知APIサービスです。SendKeyを取得し、それをトークンとして使用できます。

以下のチャネルを通じてメッセージをプッシュできます：

-   WeComアプリメッセージ：WeComクライアントをインストールせずにWeChatで直接メッセージを受信でき、全文が表示されます。
-   モバイルクライアント：Android用の公式ベータ版があり、iOSではBarkチャネルを使用できます。
-   グループボット：WeCom、DingTalk、Feishuグループ。
-   WeChat公式/テストアカウント：テンプレートメッセージインターフェースに依存します（WeChatがこのインターフェースを将来廃止する可能性があるため、いつでも切り替えられるように複数のチャネルを設定することをお勧めします）。
-   メールとSMSはネイティブではサポートされていませんが、カスタムチャネルを介して他のクラウドサービスを呼び出すことで実装できます。

> WeCom/Feishuと比較して、ServerChanはグループを作成せずに公式アカウントを介して個人のWeChatに通知をプッシュできます。

## 通知の設定

1.  **設定を開く**：ダッシュボードで、設定したい寮のサブスクリプションカードを見つけます。**設定** <Settings className="h-4 w-4 inline-block align-middle ml-1" /> ボタンをクリックして通知設定ダイアログを開きます。

2.  **チャネルを選択**：ドロップダウンメニューから通知チャネルを選択します。
    -   <InlineChannelIcon channel="none" /> **なし**: このサブスクリプションのすべての通知を無効にします。
    -   <InlineChannelIcon channel="wxwork" /> **WeCom**: WeComグループボット経由でアラートを送信します。
    -   <InlineChannelIcon channel="feishu" /> **Feishu**: Feishuグループボット経由でアラートを送信します。
    -   <InlineChannelIcon channel="serverchan" /> **ServerChan**: 個人アカウントまたは他の互換性のある通知チャネルにアラートを送信します。

3.  **トークン / Webhook URLの提供**
    -   **完全なURLを貼り付け**: トークンを自動的に抽出し、チャネルを識別します。
    -   **トークンのみを貼り付け**: 対応するチャネルを手動で選択してください。
    -   入力はリアルタイムで検証され、不正な形式は拒否されます。

4.  **通知ルールの設定**
    -   **低電力しきい値**: 寮の残りの電力が設定した`kWh`しきい値を**下回った**場合にトリガーされます。

<CodeBlock title="txt">{"Dormitricity: 低電力アラート\n寮 ${canonical_id} の残量は ${last_kwh} kWh で、しきい値の ${threshold_kwh} kWh を下回っています."}</CodeBlock>

    -   **枯渇時間しきい値**: 電力が指定された時間内に**なくなると**予測された場合にトリガーされます（最近の電力消費量に基づいて計算）。

<CodeBlock title="txt">
  {"Dormitricity: 間もなく枯渇アラート\n寮 ${canonical_id} の残量は ${last_kwh} kWh で、${hours_remaining} 時間以内になくなると予測されており、しきい値の ${within_hours} 時間を下回っています."} 
</CodeBlock>

5.  **クールダウン期間**: 12 / 24 / 48 時間などのクールダウン期間を選択して、重複メッセージを回避します。クールダウン期間中、同じルールは再度トリガーされません。

6.  **テスト**: **テスト**をクリックすると、システムは寮IDを含むテストメッセージを送信します。

<CodeBlock title="txt">
  {"Dormitricity 通知テスト\n"}
  {"寮 ${canonical_id} の通知を設定しています。これは、通知設定が正しく機能しているかを確認するためのテストメッセージです。"}
</CodeBlock>

    成功した場合、ボタンにチェックマークが表示されます。それ以外の場合は、次のようなエラーが表示されます：

<CodeBlock title="txt">
  テスト失敗: Notify API error(19001): param invalid: incoming webhook access token invalid
</CodeBlock>

7.  **保存**: 設定を確認したら、**保存**をクリックします。

8.  **サブスクリプションの解除**: 設定ダイアログで**サブスクリプションを解除**をクリックします（この操作には確認が必要です）。